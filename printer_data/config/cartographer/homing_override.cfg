#===================================================
# SENSORLESS + CARTOGRAPHER HOMING (SimpleAF-based)
# For: K1 Max â†’ Manta M8P + CM4 + Cartographer 3D
# HEAVILY COMMENTED FOR SAFETY VERIFICATION
#===================================================

[gcode_macro _SENSORLESS_PARAMS]
# These are the tunable parameters for homing behavior
# variable_homing_current: 1.5           # Current to use during XY homing (amps)
variable_homing_current: 0.8           # Current to use during XY homing (amps)
variable_safe_z: 3                     # How high to lift Z before XY movement (mm)
variable_force_move: True              # Allow force move when Z is not homed
variable_homing_move_away_x: 10        # How far to back off after X homes (mm)
variable_homing_move_away_y: 10        # How far to back off after Y homes (mm)
variable_homing_move_away_z: 10        # How high to lift after Z homes (mm)
variable_repeat_home_xy: True          # Home X and Y twice for accuracy
variable_home_y_before_x: False        # If True, home Y first; if False, home X first
gcode:

[force_move]
# Enable force_move capability (needed for initial Z lift when unhomed)
enable_force_move: true

[gcode_macro FORCE_MOVE]
# Block manual FORCE_MOVE commands - only allow via SET_KINEMATIC_POSITION
rename_existing: _FORCE_MOVE_BAD
variable_disable_force_move: True
gcode:
    # Check if force_move blocking is enabled
    {% if disable_force_move %}
        # Tell user to use safer command
        RESPOND TYPE=command MSG="Use SET_KINEMATIC_POSITION instead of FORCE_MOVE"
    {% else %}
        # If blocking disabled, allow the original command
        _FORCE_MOVE_BAD {rawparams}
    {% endif %}

#===================================================
# MAIN HOMING OVERRIDE
#===================================================
[homing_override]
axes: xyz
gcode:
    # ============================================
    # PARSE WHICH AXES TO HOME
    # ============================================
    # Convert user's G28 command to uppercase
    {% set uparams = rawparams | upper %}
    
    # Check if X was requested (G28 X or G28 X Y, etc.)
    {% set home_x = 'X' in uparams %}
    
    # Check if Y was requested
    {% set home_y = 'Y' in uparams %}
    
    # Check if Z was requested
    {% set home_z = 'Z' in uparams %}
    
    # If all three axes requested OR no axes specified (plain G28), home everything
    {% set home_all = (home_x and home_y and home_z) or (not home_x and not home_y and not home_z) %}

    # ============================================
    # CHECK IF SENSORLESS HOMING IS CONFIGURED
    # ============================================
    # Look in printer.cfg to see if X uses virtual_endstop (sensorless)
    # AND if Y uses virtual_endstop (sensorless)
    {% set sensorless_homing = (
        'virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin and
        'virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin
    ) %}
    
    # Get the repeat_home_xy setting (home twice for accuracy)
    {% set repeat_home_xy = printer["gcode_macro _SENSORLESS_PARAMS"].repeat_home_xy %}
    
    # If sensorless AND repeat enabled, home 2 times; otherwise just 1 time
    {% set home_count = 2 if sensorless_homing and repeat_home_xy else 1 %}
    
    # Get the axis order preference (Y before X, or X before Y)
    {% set home_y_before_x = printer["gcode_macro _SENSORLESS_PARAMS"].home_y_before_x %}
    
    # Create the homing order: ['y', 'x'] if Y first, or ['x', 'y'] if X first
    {% set home_axes_order = ['y', 'x'] if home_y_before_x else ['x', 'y'] %}

    # ============================================
    # SET ABSOLUTE POSITIONING MODE
    # ============================================
    G90

    # ============================================
    # SAFETY: LIFT Z BEFORE ANY XY MOTION
    # ============================================
    # If we're homing X and/or Y (or all axes)
    {% if home_all or home_x or home_y %}
        # Run the pre-home XY safety macro
        # This will lift Z if not already homed to prevent bed crashes
        _PRE_HOME_XY HOME_ALL={1 if home_all else 0}
    {% endif %}

    # ============================================
    # SENSORLESS X/Y HOMING LOOP
    # ============================================
    # Loop for the number of homing attempts (1 or 2)
    {% for repeat in range(0, home_count) %}
        # Loop through each axis in the preferred order
        {% for axes in home_axes_order %}
            # ===== HOME X AXIS =====
            # If this is the X axis AND (we want all axes OR just X)
            {% if axes == 'x' and (home_all or home_x) %}
                # Prepare for X homing (lower current for sensorless)
                _PRE_HOME_X
                # Execute the actual X homing move
                G28 X
                # Clean up after X homing (restore current, back off)
                _POST_HOME_X
            # ===== HOME Y AXIS =====
            # If this is the Y axis AND (we want all axes OR just Y)
            {% elif axes == 'y' and (home_all or home_y) %}
                # Prepare for Y homing (lower current for sensorless)
                _PRE_HOME_Y
                # Execute the actual Y homing move
                G28 Y
                # Clean up after Y homing (restore current, back off)
                _POST_HOME_Y
            {% endif %}
        {% endfor %}
    {% endfor %}

    # ============================================
    # MOVE TO BED CENTER AFTER XY HOMING
    # ============================================
    # If we homed all axes OR both X and Y
    {% if home_all or (home_x and home_y) %}
        # Move to center of bed for convenience
        _POST_HOME_XY
    {% endif %}

    # ============================================
    # CARTOGRAPHER Z HOMING
    # ============================================
    # If we want to home all axes OR just Z
    {% if home_all or home_z %}
        # Prepare for Z homing (nothing needed for Cartographer)
        _PRE_HOME_Z
        # Execute the actual Z homing with Cartographer probe
        G28 Z
        # Clean up after Z homing (lift Z to safe height)
        _POST_HOME_Z
    {% endif %}

#===================================================
# PRE-HOMING SAFETY MACROS
#===================================================

[gcode_macro _PRE_HOME_XY]
gcode:
    # ============================================
    # CRITICAL SAFETY: LIFT Z BEFORE XY MOTION
    # ============================================
    # Get the force_move setting (allows moving Z when not homed)
    {% set force_move = printer["gcode_macro _SENSORLESS_PARAMS"].force_move %}
    
    # Get the safe Z height to lift to (default 3mm)
    {% set safe_z = printer["gcode_macro _SENSORLESS_PARAMS"].safe_z|int %}
    
    # Check if this is a full home (all axes)
    {% set home_all = (params.HOME_ALL|default(0)|int == 1) %}

    # Check if printer is NOT fully homed (not all of xyz are homed)
    # AND force_move is enabled
    {% if printer.toolhead.homed_axes != "xyz" and force_move %}
        # SAFETY WARNING: Z is not homed, we need to lift it before XY moves
        RESPOND TYPE=command MSG="Force moving Z {safe_z}mm for safety"
        
        # Tell Klipper to assume Z is at 0 (even though we don't know where it is)
        SET_KINEMATIC_POSITION Z=0
        
        # Move Z up by safe_z amount (e.g., 3mm)
        # This prevents nozzle dragging on bed during XY homing
        G0 Z{safe_z} F600
        
        # Wait for the move to complete before continuing
        M400
        
        # If this is NOT a full home (just homing X or Y individually)
        {% if not home_all %}
            # Clear the fake Z position we set
            # This prevents false "homed" status when we only homed X or Y
            SET_KINEMATIC_POSITION CLEAR=Z
        {% endif %}
    {% endif %}

[gcode_macro _PRE_HOME_X]
gcode:
    # Check if X axis is configured for sensorless homing
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin) %}
    
    # Only do current adjustment if using sensorless
    {% if sensorless_homing %}
        # Get the homing current from parameters (e.g., 1.5A)
        {% set HOMING_CURRENT = printer["gcode_macro _SENSORLESS_PARAMS"].homing_current %}
        
        # IMPORTANT: Lower current on BOTH X and Y motors
        # This makes sensorless detection more sensitive/reliable
        # CoreXY needs both motors at same current
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOMING_CURRENT}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOMING_CURRENT}
    {% endif %}

[gcode_macro _PRE_HOME_Y]
gcode:
    # Check if Y axis is configured for sensorless homing
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin) %}
    
    # Only do current adjustment if using sensorless
    {% if sensorless_homing %}
        # Get the homing current from parameters (e.g., 1.5A)
        {% set HOMING_CURRENT = printer["gcode_macro _SENSORLESS_PARAMS"].homing_current %}
        
        # IMPORTANT: Lower current on BOTH X and Y motors
        # This makes sensorless detection more sensitive/reliable
        # CoreXY needs both motors at same current
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOMING_CURRENT}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOMING_CURRENT}
    {% endif %}

[gcode_macro _PRE_HOME_Z]
gcode:
    # Cartographer probe is always attached (no dock/undock needed)
    # Just set absolute positioning mode
    G90

#===================================================
# POST-HOMING CLEANUP MACROS
#===================================================

[gcode_macro _POST_HOME_X]
gcode:
    # Check if X axis is configured for sensorless homing
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin) %}
    
    # Only do back-off and current restore if using sensorless
    {% if sensorless_homing %}
        # Get how far to back away from endstop (e.g., 10mm)
        {% set homing_move_away_x = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_x %}
        
        # Get where the X endstop is located (e.g., 306.5 for max)
        {% set x_position_endstop = printer.configfile.settings['stepper_x'].position_endstop %}
        
        # Get the minimum X position (e.g., -5)
        {% set x_position_min = printer.configfile.settings['stepper_x'].position_min %}
        
        # Switch to relative positioning for the back-off move
        G91
        
        # Determine which direction to back off
        # If endstop is at max (306.5 > -5), back off in negative direction
        {% if x_position_endstop > x_position_min %}
            # Move LEFT (negative X) to get away from max endstop
            G1 X-{homing_move_away_x} F1200
        {% else %}
            # If endstop were at min, move RIGHT (positive X) to get away
            G1 X+{homing_move_away_x} F1200
        {% endif %}

        # Wait 1 second for TMC StallGuard registers to clear
        # This prevents false stall detection on next move
        G4 P1000
        
        # Get the normal run current for X from config (e.g., 1.35A)
        {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
        
        # Get the normal run current for Y from config (e.g., 1.35A)
        {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
        
        # RESTORE normal operating currents (from homing current back to run current)
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    {% endif %}

[gcode_macro _POST_HOME_Y]
gcode:
    # Check if Y axis is configured for sensorless homing
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin) %}
    
    # Only do back-off and current restore if using sensorless
    {% if sensorless_homing %}
        # Get how far to back away from endstop (e.g., 10mm)
        {% set homing_move_away_y = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_y %}
        
        # Get where the Y endstop is located (e.g., -2 for min)
        {% set y_position_endstop = printer.configfile.settings['stepper_y'].position_endstop %}
        
        # Get the minimum Y position (e.g., -2)
        {% set y_position_min = printer.configfile.settings['stepper_y'].position_min %}
        
        # Switch to relative positioning for the back-off move
        G91
        
        # Determine which direction to back off
        # If endstop is at max (unlikely for Y), back off in negative direction
        {% if y_position_endstop > y_position_min %}
            # If Y endstop were at max, move FORWARD (negative Y) to get away
            G1 Y-{homing_move_away_y} F1200
        {% else %}
            # Y endstop is at min (-2), move BACK (positive Y) to get away
            G1 Y+{homing_move_away_y} F1200
        {% endif %}

        # Wait 1 second for TMC StallGuard registers to clear
        G4 P1000
        
        # Get the normal run current for X from config (e.g., 1.35A)
        {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
        
        # Get the normal run current for Y from config (e.g., 1.35A)
        {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
        
        # RESTORE normal operating currents (from homing current back to run current)
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    {% endif %}

[gcode_macro _POST_HOME_Z]
gcode:
    # Get the Z-hop height after homing (e.g., 10mm)
    {% set homing_move_away_z = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_z|int %}
    
    # Set absolute positioning
    G90
    
    # Lift Z to safe height after probing
    # This prevents nozzle from dragging if user moves XY
    G1 Z{homing_move_away_z} F1200

[gcode_macro _POST_HOME_XY]
gcode:
    # Check if both X and Y are now homed
    {% if "xy" in printer.toolhead.homed_axes %}
        # Calculate center X position (half of max X travel)
        {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max/2 %}
        
        # Calculate center Y position (half of max Y travel)
        {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max/2 %}
        
        # Set absolute positioning
        G90
        
        # Move to bed center for convenience
        # This is a safe central location after homing
        G0 X{POSITION_X} Y{POSITION_Y} F3200
    {% endif %}