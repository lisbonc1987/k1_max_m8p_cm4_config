# ============================
# Cartographer - General
# ============================

[gcode_macro CARTO_TOUCH_PROBE]
description: Cartographer – Touch Probe
gcode:
    CARTOGRAPHER_TOUCH_PROBE

[gcode_macro CARTO_TOUCH_HOME]
description: Cartographer – Touch Home
gcode:
    CARTOGRAPHER_TOUCH_HOME

[gcode_macro CARTO_SCAN_MODEL]
description: Cartographer – Scan Model
gcode:
    CARTOGRAPHER_SCAN_MODEL LOAD={params.LOAD|default("default")} REMOVE={params.REMOVE|default("")}

[gcode_macro CARTO_TOUCH_MODEL]
description: Cartographer – Touch Model
gcode:
    CARTOGRAPHER_TOUCH_MODEL LOAD={params.LOAD|default("default")} REMOVE={params.REMOVE|default("")}


# ============================
# Cartographer - Calibration
# ============================

[gcode_macro CARTO_SCAN_CALIBRATE]
description: Cartographer – Scan Calibrate
gcode:
    CARTOGRAPHER_SCAN_CALIBRATE MODEL={params.MODEL|default("default")} METHOD={params.METHOD|default("manual")}

[gcode_macro CARTO_ESTIMATE_BACKLASH]
description: Cartographer – Backlash Estimation
gcode:
    CARTOGRAPHER_ESTIMATE_BACKLASH ITERATIONS={params.ITERATIONS|default(10)} DELTA={params.DELTA|default(0.2)} { "CALIBRATE=1" if params.CALIBRATE|default(0)|int == 1 else "" }

[gcode_macro CARTO_TOUCH_CALIBRATE]
description: Cartographer – Touch Calibrate
gcode:
    CARTOGRAPHER_TOUCH_CALIBRATE MODEL={params.MODEL|default("default")} SPEED={params.SPEED|default(2)} START={params.START|default(500)} MAX={params.MAX|default(3000)} STRATEGY={params.STRATEGY|default("default")}

[gcode_macro CARTO_AXIS_TWIST]
description: Cartographer – Axis Twist Compensation
gcode:
    CARTOGRAPHER_AXIS_TWIST_COMPENSATION AXIS={params.AXIS} SAMPLE_COUNT={params.SAMPLE_COUNT|default(5)} START={params.START|default("")} END={params.END|default("")} LINE={params.LINE|default("")}

[gcode_macro CARTO_TEMP_CALIBRATE]
description: Cartographer – Temperature Calibration
gcode:
    CARTOGRAPHER_TEMPERATURE_CALIBRATE BED_TEMP={params.BED_TEMP|default(90)} MIN_TEMP={params.MIN_TEMP|default(40)} MAX_TEMP={params.MAX_TEMP|default(70)} Z_SPEED={params.Z_SPEED|default(5)}


# ============================
# Cartographer - Troubleshooting
# ============================

[gcode_macro CARTO_SCAN_ACCURACY]
description: Cartographer – Scan Accuracy Test
gcode:
    CARTOGRAPHER_SCAN_ACCURACY SAMPLES={params.SAMPLES|default(100)} READINGS={params.READINGS|default(20)}

[gcode_macro CARTO_STREAM]
description: Cartographer – Data Stream
gcode:
    CARTOGRAPHER_STREAM ACTION={params.ACTION|default("status")} FILE={params.FILE|default("~/stream.csv")}

[gcode_macro CARTO_TOUCH_ACCURACY]
description: Cartographer – Touch Accuracy Test
gcode:
    CARTOGRAPHER_TOUCH_ACCURACY SAMPLES={params.SAMPLES|default(5)} LIFT_SPEED={params.LIFT_SPEED|default(5)} SAMPLE_RETRACT_DIST={params.SAMPLE_RETRACT_DIST|default(2)}

# ============================
# Cartographer - Bed Mesh
# ============================
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set max_velocity = printer.toolhead.max_velocity %}
    {% set max_accel = printer.toolhead.max_accel %}
    {% set max_square_corner_velocity = printer.toolhead.square_corner_velocity %}

    # Inline parameters instead of START_END_PARAMS
    {% set start_max_velocity = 400 %}
    {% set start_max_accel = 10000 %}
    {% set start_max_square_corner_velocity = 5.0 %}

    {% if printer["gcode_macro _SAF_BED_MESH_START"] != null %}
        _SAF_BED_MESH_START
    {% endif %}

    {% if max_velocity > start_max_velocity or max_accel > start_max_accel or max_square_corner_velocity > start_max_square_corner_velocity %}
        RESPOND TYPE=command MSG='Setting VELOCITY={start_max_velocity} (was {max_velocity}) ACCEL={start_max_accel} (was {max_accel}) SQUARE_CORNER_VELOCITY={start_max_square_corner_velocity} (was {max_square_corner_velocity})'
        SET_VELOCITY_LIMIT VELOCITY={start_max_velocity} ACCEL={start_max_accel} SQUARE_CORNER_VELOCITY={start_max_square_corner_velocity}
    {% endif %}

    _BED_MESH_CALIBRATE {rawparams}

    {% if max_velocity > start_max_velocity or max_accel > start_max_accel or max_square_corner_velocity > start_max_square_corner_velocity %}
        RESPOND TYPE=command MSG='Restoring VELOCITY={max_velocity} ACCEL={max_accel} SQUARE_CORNER_VELOCITY={max_square_corner_velocity}'
        SET_VELOCITY_LIMIT VELOCITY={max_velocity} ACCEL={max_accel} SQUARE_CORNER_VELOCITY={max_square_corner_velocity}
    {% endif %}

    {% if printer["gcode_macro _SAF_BED_MESH_END"] != null %}
        _SAF_BED_MESH_END
    {% endif %}

[gcode_macro _SAF_BED_MESH_END]
gcode:
    {% set mesh_min = printer.configfile.settings['bed_mesh'].mesh_min %}
    {% set mesh_min_x = mesh_min[0] %}
    {% set mesh_min_y = mesh_min[1] %}

    G90
    G1 Z10 F6000
    G1 X{mesh_min_x} Y{mesh_min_y} F8000

# [gcode_macro _SAF_BED_MESH_END]
# gcode:
#     # Ensure XY is homed before moving
#     {% if "xy" not in printer.toolhead.homed_axes %}
#         RESPOND TYPE=error MSG="XY must be homed before mesh-end park!"
#         {% return %}
#     {% endif %}

#     {% set mesh_min_x = printer.configfile.settings['bed_mesh'].mesh_min.split(",")[0] | float %}
#     {% set mesh_min_y = printer.configfile.settings['bed_mesh'].mesh_min.split(",")[1] | float %}

#     G90
#     G1 Z10 F6000
#     G1 X{mesh_min_x} Y{mesh_min_y} F8000