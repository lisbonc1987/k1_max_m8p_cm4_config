# ============================
# Cartographer - General
# ============================

[gcode_macro CARTO_TOUCH_PROBE]
description: Cartographer – Touch Probe
gcode:
    CARTOGRAPHER_TOUCH_PROBE

[gcode_macro CARTO_TOUCH_HOME]
description: Cartographer – Touch Home
gcode:
    CARTOGRAPHER_TOUCH_HOME

[gcode_macro CARTO_SCAN_MODEL]
description: Cartographer – Manage Scan Models

# ---- Default macro variables ----
variable_load: ""
variable_remove: ""

gcode:
    {% set load = params.LOAD|default(variable_load) %}
    {% set remove = params.REMOVE|default(variable_remove) %}

    CARTOGRAPHER_SCAN_MODEL \
        LOAD={load} \
        REMOVE={remove}

[gcode_macro CARTO_TOUCH_MODEL]
description: Cartographer – Manage Touch Models

# ---- Default macro variables ----
variable_load: ""
variable_remove: ""

gcode:
    {% set load = params.LOAD|default(variable_load) %}
    {% set remove = params.REMOVE|default(variable_remove) %}

    CARTOGRAPHER_TOUCH_MODEL \
        LOAD={load} \
        REMOVE={remove}

# ============================
# Cartographer - Calibration
# ============================

[gcode_macro CARTO_SCAN_CALIBRATE]
description: Cartographer – Scan Calibration

# ---- Default macro variables ----
variable_model: "default"
variable_method: "manual"

gcode:
    {% set model = params.MODEL|default(variable_model) %}
    {% set method = params.METHOD|default(variable_method) %}

    CARTOGRAPHER_SCAN_CALIBRATE \
        MODEL={model} \
        METHOD={method}

[gcode_macro CARTO_ESTIMATE_BACKLASH]
description: Cartographer – Backlash Estimation

# ---- Default macro variables ----
variable_iterations: 10
variable_delta: 0.2
variable_calibrate: 1

gcode:
    {% set iters = params.ITERATIONS|default(variable_iterations) %}
    {% set delta = params.DELTA|default(variable_delta) %}
    {% set calibrate = params.CALIBRATE|default(variable_calibrate) %}

    CARTOGRAPHER_ESTIMATE_BACKLASH \
        ITERATIONS={iters} \
        DELTA={delta} \
        CALIBRATE={calibrate}

[gcode_macro CARTO_TOUCH_CALIBRATE]
description: Cartographer – Touch Calibration

# ---- Default macro variables ----
variable_model: "default"
variable_speed: 2
variable_start: 500
variable_max: 3000
variable_strategy: "default"

gcode:
    {% set model = params.MODEL|default(variable_model) %}
    {% set speed = params.SPEED|default(variable_speed) %}
    {% set start = params.START|default(variable_start) %}
    {% set maxf = params.MAX|default(variable_max) %}
    {% set strategy = params.STRATEGY|default(variable_strategy) %}

    CARTOGRAPHER_TOUCH_CALIBRATE \
        MODEL={model} \
        SPEED={speed} \
        START={start} \
        MAX={maxf} \
        STRATEGY={strategy}

[gcode_macro CARTO_AXIS_TWIST]
description: Cartographer – Axis Twist Compensation
variable_axis: "X"             # default axis if user doesn't specify AXIS=
variable_sample_count: 5        # default sample count (Cartographer uses 5 by default)
variable_start: ""              # default empty (Cartographer falls back to config values)
variable_end: ""                # default empty
variable_line: ""               # default empty

gcode:
    {% set axis = params.AXIS|default(variable_axis) %}
    {% set sample = params.SAMPLE_COUNT|default(variable_sample_count) %}
    {% set start = params.START|default(variable_start) %}
    {% set end = params.END|default(variable_end) %}
    {% set line = params.LINE|default(variable_line) %}

    CARTOGRAPHER_AXIS_TWIST_COMPENSATION \
        AXIS={axis} \
        SAMPLE_COUNT={sample} \
        START={start} \
        END={end} \
        LINE={line}


[gcode_macro CARTO_TEMP_CALIBRATE]
description: Cartographer – Temperature Calibration

# ---- Default macro variables ----
# (You can edit these in the cfg file if you want new defaults)
variable_bed_temp: 90
variable_min_temp: 40
variable_max_temp: 70
variable_z_speed: 5

gcode:
    {% set bed = params.BED_TEMP|default(variable_bed_temp) %}
    {% set tmin = params.MIN_TEMP|default(variable_min_temp) %}
    {% set tmax = params.MAX_TEMP|default(variable_max_temp) %}
    {% set zspd = params.Z_SPEED|default(variable_z_speed) %}

    CARTOGRAPHER_TEMPERATURE_CALIBRATE \
        BED_TEMP={bed} \
        MIN_TEMP={tmin} \
        MAX_TEMP={tmax} \
        Z_SPEED={zspd}

# ============================
# Cartographer - Troubleshooting
# ============================

[gcode_macro CARTO_SCAN_ACCURACY]
description: Cartographer – Scan Accuracy Test

# ---- Default macro variables ----
variable_samples: 100
variable_readings: 20

gcode:
    {% set samples = params.SAMPLES|default(variable_samples) %}
    {% set readings = params.READINGS|default(variable_readings) %}

    CARTOGRAPHER_SCAN_ACCURACY \
        SAMPLES={samples} \
        READINGS={readings}

[gcode_macro CARTO_STREAM]
description: Cartographer – Data Stream Control

# ---- Default macro variables ----
variable_action: "status"
variable_file: "~/stream.csv"

gcode:
    {% set action = params.ACTION|default(variable_action) %}
    {% set file = params.FILE|default(variable_file) %}

    CARTOGRAPHER_STREAM \
        ACTION={action} \
        FILE="{file}"

[gcode_macro CARTO_TOUCH_ACCURACY]
description: Cartographer – Touch Accuracy Test

# ---- Default macro variables ----
variable_samples: 5
variable_lift_speed: 5
variable_sample_retract_dist: 2

gcode:
    {% set samples = params.SAMPLES|default(variable_samples) %}
    {% set lift = params.LIFT_SPEED|default(variable_lift_speed) %}
    {% set retract = params.SAMPLE_RETRACT_DIST|default(variable_sample_retract_dist) %}

    CARTOGRAPHER_TOUCH_ACCURACY \
        SAMPLES={samples} \
        LIFT_SPEED={lift} \
        SAMPLE_RETRACT_DIST={retract}

# # ============================
# # Cartographer - Bed Mesh
# # ============================
# [gcode_macro BED_MESH_CALIBRATE]
# rename_existing: _BED_MESH_CALIBRATE
# gcode:
#     {% set max_velocity = printer.toolhead.max_velocity %}
#     {% set max_accel = printer.toolhead.max_accel %}
#     {% set max_square_corner_velocity = printer.toolhead.square_corner_velocity %}

#     # Inline parameters instead of START_END_PARAMS
#     {% set start_max_velocity = 400 %}
#     {% set start_max_accel = 10000 %}
#     {% set start_max_square_corner_velocity = 5.0 %}

#     {% if printer["gcode_macro _SAF_BED_MESH_START"] != null %}
#         _SAF_BED_MESH_START
#     {% endif %}

#     {% if max_velocity > start_max_velocity or max_accel > start_max_accel or max_square_corner_velocity > start_max_square_corner_velocity %}
#         RESPOND TYPE=command MSG='Setting VELOCITY={start_max_velocity} (was {max_velocity}) ACCEL={start_max_accel} (was {max_accel}) SQUARE_CORNER_VELOCITY={start_max_square_corner_velocity} (was {max_square_corner_velocity})'
#         SET_VELOCITY_LIMIT VELOCITY={start_max_velocity} ACCEL={start_max_accel} SQUARE_CORNER_VELOCITY={start_max_square_corner_velocity}
#     {% endif %}

#     _BED_MESH_CALIBRATE {rawparams}

#     {% if max_velocity > start_max_velocity or max_accel > start_max_accel or max_square_corner_velocity > start_max_square_corner_velocity %}
#         RESPOND TYPE=command MSG='Restoring VELOCITY={max_velocity} ACCEL={max_accel} SQUARE_CORNER_VELOCITY={max_square_corner_velocity}'
#         SET_VELOCITY_LIMIT VELOCITY={max_velocity} ACCEL={max_accel} SQUARE_CORNER_VELOCITY={max_square_corner_velocity}
#     {% endif %}

#     {% if printer["gcode_macro _SAF_BED_MESH_END"] != null %}
#         _SAF_BED_MESH_END
#     {% endif %}

# [gcode_macro _SAF_BED_MESH_END]
# gcode:
#     {% set mesh_min = printer.configfile.settings['bed_mesh'].mesh_min %}
#     {% set mesh_min_x = mesh_min[0] %}
#     {% set mesh_min_y = mesh_min[1] %}

#     G90
#     G1 Z10 F6000
#     G1 X{mesh_min_x} Y{mesh_min_y} F8000

# [gcode_macro _SAF_BED_MESH_END]
# gcode:
#     # Ensure XY is homed before moving
#     {% if "xy" not in printer.toolhead.homed_axes %}
#         RESPOND TYPE=error MSG="XY must be homed before mesh-end park!"
#         {% return %}
#     {% endif %}

#     {% set mesh_min_x = printer.configfile.settings['bed_mesh'].mesh_min.split(",")[0] | float %}
#     {% set mesh_min_y = printer.configfile.settings['bed_mesh'].mesh_min.split(",")[1] | float %}

#     G90
#     G1 Z10 F6000
#     G1 X{mesh_min_x} Y{mesh_min_y} F8000