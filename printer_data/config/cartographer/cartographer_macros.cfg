# ============================
# Cartographer - General
# ============================

[gcode_macro CARTO_TOUCH_PROBE]
description: Cartographer – Touch Probe
gcode:
    CARTOGRAPHER_TOUCH_PROBE

[gcode_macro CARTO_TOUCH_HOME]
description: Cartographer – Touch Home
gcode:
    CARTOGRAPHER_TOUCH_HOME

[gcode_macro CARTO_SCAN_MODEL]
description: Cartographer – Manage Scan Models
gcode:
    {% if params.LOAD %}
        CARTOGRAPHER_SCAN_MODEL LOAD={params.LOAD}
    {% elif params.REMOVE %}
        CARTOGRAPHER_SCAN_MODEL REMOVE={params.REMOVE}
    {% else %}
        {action_respond_info("Usage: CARTO_SCAN_MODEL LOAD=<name> or REMOVE=<name>")}
    {% endif %}

[gcode_macro CARTO_TOUCH_MODEL]
description: Cartographer – Manage Touch Models
gcode:
    {% if params.LOAD %}
        CARTOGRAPHER_TOUCH_MODEL LOAD={params.LOAD}
    {% elif params.REMOVE %}
        CARTOGRAPHER_TOUCH_MODEL REMOVE={params.REMOVE}
    {% else %}
        {action_respond_info("Usage: CARTO_TOUCH_MODEL LOAD=<name> or REMOVE=<name>")}
    {% endif %}

# ============================
# Cartographer - Calibration
# ============================

[gcode_macro CARTO_SCAN_CALIBRATE]
description: Cartographer – Scan Calibration
variable_model: "default"
variable_method: "manual"
gcode:
    {% set model = params.MODEL|default(variable_model) %}
    {% set method = params.METHOD|default(variable_method) %}
    CARTOGRAPHER_SCAN_CALIBRATE MODEL={model} METHOD={method}

[gcode_macro CARTO_ESTIMATE_BACKLASH]
description: Cartographer – Backlash Estimation
variable_iterations: 10
variable_delta: 0.2
variable_calibrate: 1
gcode:
    {% set iters = params.ITERATIONS|default(variable_iterations)|int %}
    {% set delta = params.DELTA|default(variable_delta)|float %}
    {% set calibrate = params.CALIBRATE|default(variable_calibrate)|int %}
    CARTOGRAPHER_ESTIMATE_BACKLASH ITERATIONS={iters} DELTA={delta} CALIBRATE={calibrate}

[gcode_macro CARTO_TOUCH_CALIBRATE]
description: Cartographer – Touch Calibration
variable_model: "default"
variable_speed: 2
variable_start: 500
variable_max: 3000
variable_strategy: "default"
gcode:
    {% set model = params.MODEL|default(variable_model) %}
    {% set speed = params.SPEED|default(variable_speed)|float %}
    {% set start = params.START|default(variable_start)|int %}
    {% set maxf = params.MAX|default(variable_max)|int %}
    {% set strategy = params.STRATEGY|default(variable_strategy) %}
    CARTOGRAPHER_TOUCH_CALIBRATE MODEL={model} SPEED={speed} START={start} MAX={maxf} STRATEGY={strategy}

[gcode_macro CARTO_AXIS_TWIST]
description: Cartographer – Axis Twist Compensation
gcode:
    {% set axis = params.AXIS|default("X") %}
    {% set sample = params.SAMPLE_COUNT|default(5)|int %}
    
    {% if params.START and params.END %}
        CARTOGRAPHER_AXIS_TWIST_COMPENSATION AXIS={axis} SAMPLE_COUNT={sample} START={params.START} END={params.END}
    {% elif params.LINE %}
        CARTOGRAPHER_AXIS_TWIST_COMPENSATION AXIS={axis} SAMPLE_COUNT={sample} LINE={params.LINE}
    {% else %}
        CARTOGRAPHER_AXIS_TWIST_COMPENSATION AXIS={axis} SAMPLE_COUNT={sample}
    {% endif %}

[gcode_macro CARTO_TEMP_CALIBRATE]
description: Cartographer – Temperature Calibration
variable_bed_temp: 90
variable_min_temp: 40
variable_max_temp: 70
variable_z_speed: 5
gcode:
    {% set bed = params.BED_TEMP|default(variable_bed_temp)|int %}
    {% set tmin = params.MIN_TEMP|default(variable_min_temp)|int %}
    {% set tmax = params.MAX_TEMP|default(variable_max_temp)|int %}
    {% set zspd = params.Z_SPEED|default(variable_z_speed)|float %}
    CARTOGRAPHER_TEMPERATURE_CALIBRATE BED_TEMP={bed} MIN_TEMP={tmin} MAX_TEMP={tmax} Z_SPEED={zspd}

# ============================
# Cartographer - Troubleshooting
# ============================

[gcode_macro CARTO_SCAN_ACCURACY]
description: Cartographer – Scan Accuracy Test
variable_samples: 100
variable_readings: 20
gcode:
    {% set samples = params.SAMPLES|default(variable_samples)|int %}
    {% set readings = params.READINGS|default(variable_readings)|int %}
    CARTOGRAPHER_SCAN_ACCURACY SAMPLES={samples} READINGS={readings}

[gcode_macro CARTO_STREAM]
description: Cartographer – Data Stream Control
variable_action: "status"
variable_file: "~/stream.csv"
gcode:
    {% set action = params.ACTION|default(variable_action) %}
    {% set file = params.FILE|default(variable_file) %}
    CARTOGRAPHER_STREAM ACTION={action} FILE="{file}"

[gcode_macro CARTO_TOUCH_ACCURACY]
description: Cartographer – Touch Accuracy Test
variable_samples: 5
variable_lift_speed: 5
variable_sample_retract_dist: 2
gcode:
    {% set samples = params.SAMPLES|default(variable_samples)|int %}
    {% set lift = params.LIFT_SPEED|default(variable_lift_speed)|float %}
    {% set retract = params.SAMPLE_RETRACT_DIST|default(variable_sample_retract_dist)|float %}
    CARTOGRAPHER_TOUCH_ACCURACY SAMPLES={samples} LIFT_SPEED={lift} SAMPLE_RETRACT_DIST={retract}