#===================================================
#  SENSORLESS + CARTOGRAPHER HOMING (ADAPTED SIMPLEAF)
#  For: Manta M8P + CM4 + Cartographer 3D probe
#  No Eddy, no Klicky, no SAF Z-endstop, no camera logic
#===================================================

[gcode_macro _SENSORLESS_PARAMS]
variable_homing_current: 1.5
variable_safe_z: 3
variable_force_move: True
variable_homing_move_away_x: 10
variable_homing_move_away_y: 10
variable_homing_move_away_z: 10
variable_repeat_home_xy: True
variable_home_y_before_x: False
gcode:

[force_move]
enable_force_move: true

[gcode_macro FORCE_MOVE]
rename_existing: _FORCE_MOVE_BAD
variable_disable_force_move: True
gcode:
  RESPOND TYPE=command MSG="Use SET_KINEMATIC_POSITION instead of FORCE_MOVE"

#===================================================
#  MAIN HOMING OVERRIDE
#===================================================
[homing_override]
axes: xyz
gcode:
    {% set u = rawparams|upper %}
    {% set home_x = 'X' in u %}
    {% set home_y = 'Y' in u %}
    {% set home_z = 'Z' in u %}
    {% set home_all = (home_x and home_y and home_z) or (not home_x and not home_y and not home_z) %}

    {% set sensorless = (
        'virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin
        and 'virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin
    ) %}
    {% set repeat_xy = printer["gcode_macro _SENSORLESS_PARAMS"].repeat_home_xy %}
    {% set home_count = 2 if sensorless and repeat_xy else 1 %}
    {% set order = ['y','x'] if printer["gcode_macro _SENSORLESS_PARAMS"].home_y_before_x else ['x','y'] %}

    G90

    # safe lift before any XY motion
    {% if home_all or home_x or home_y %}
        _PRE_HOME_XY HOME_ALL={1 if home_all else 0}
    {% endif %}

    #======================
    #  SENSORLESS X/Y
    #======================
    {% for r in range(0, home_count) %}
      {% for axis in order %}
        {% if axis == 'x' and (home_all or home_x) %}
            _PRE_HOME_X
            G28 X
            _POST_HOME_X
        {% elif axis == 'y' and (home_all or home_y) %}
            _PRE_HOME_Y
            G28 Y
            _POST_HOME_Y
        {% endif %}
      {% endfor %}
    {% endfor %}

    # Move to bed center after XY homing
    {% if home_all or (home_x and home_y) %}
        _POST_HOME_XY
    {% endif %}

    #======================
    #  CARTOGRAPHER Z HOMING
    #======================
    {% if home_all or home_z %}
        _PRE_HOME_Z
        G28 Z
        _POST_HOME_Z
    {% endif %}

#===================================================
#  Supporting Macros
#===================================================
[gcode_macro _PRE_HOME_X]
gcode:
  {% if 'virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin %}
    {% set C = printer["gcode_macro _SENSORLESS_PARAMS"].homing_current %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={C}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={C}
  {% endif %}

[gcode_macro _PRE_HOME_Y]
gcode:
  {% if 'virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin %}
    {% set C = printer["gcode_macro _SENSORLESS_PARAMS"].homing_current %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={C}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={C}
  {% endif %}

[gcode_macro _PRE_HOME_Z]
gcode:
  # Cartographer requires no attach/dock logic
  G90

[gcode_macro _POST_HOME_X]
gcode:
    {% if 'virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin %}
      {% set move = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_x %}
      {% set end = printer.configfile.settings['stepper_x'].position_endstop %}
      {% set min = printer.configfile.settings['stepper_x'].position_min %}
      G91
      {% if end > min %}
        G1 X-{move} F1200
      {% else %}
        G1 X+{move} F1200
      {% endif %}
      G4 P800
      # restore run currents
      {% set rx = printer.configfile.settings['tmc2209 stepper_x'].run_current %}
      {% set ry = printer.configfile.settings['tmc2209 stepper_y'].run_current %}
      SET_TMC_CURRENT STEPPER=stepper_x CURRENT={rx}
      SET_TMC_CURRENT STEPPER=stepper_y CURRENT={ry}
    {% endif %}

[gcode_macro _POST_HOME_Y]
gcode:
    {% if 'virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin %}
      {% set move = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_y %}
      {% set end = printer.configfile.settings['stepper_y'].position_endstop %}
      {% set min = printer.configfile.settings['stepper_y'].position_min %}
      G91
      {% if end > min %}
        G1 Y-{move} F1200
      {% else %}
        G1 Y+{move} F1200
      {% endif %}
      G4 P800
      {% set rx = printer.configfile.settings['tmc2209 stepper_x'].run_current %}
      {% set ry = printer.configfile.settings['tmc2209 stepper_y'].run_current %}
      SET_TMC_CURRENT STEPPER=stepper_x CURRENT={rx}
      SET_TMC_CURRENT STEPPER=stepper_y CURRENT={ry}
    {% endif %}

[gcode_macro _POST_HOME_Z]
gcode:
  {% set zhop = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_z %}
  G90
  G1 Z{zhop} F1200

[gcode_macro _PRE_HOME_XY]
gcode:
  {% set FM = printer["gcode_macro _SENSORLESS_PARAMS"].force_move %}
  {% set safe_z = printer["gcode_macro _SENSORLESS_PARAMS"].safe_z %}
  {% set home_all = (params.HOME_ALL|default(0)|int == 1) %}
  {% if printer.toolhead.homed_axes != "xyz" and FM %}
      SET_KINEMATIC_POSITION Z=0
      G0 Z{safe_z} F600
      M400
      {% if not home_all %}
        SET_KINEMATIC_POSITION CLEAR=Z
      {% endif %}
  {% endif %}

[gcode_macro _POST_HOME_XY]
gcode:
    {% if "xy" in printer.toolhead.homed_axes %}
        {% set X = printer.configfile.settings['stepper_x'].position_max/2 %}
        {% set Y = printer.configfile.settings['stepper_y'].position_max/2 %}
        G90
        G0 X{X} Y{Y} F3200
    {% endif %}
