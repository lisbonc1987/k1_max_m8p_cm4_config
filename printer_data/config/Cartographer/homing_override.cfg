#===================================================
# SENSORLESS + CARTOGRAPHER HOMING (SimpleAF-based)
# For: K1 Max â†’ Manta M8P + CM4 + Cartographer 3D
# Stripped to Cartographer-only, no Klicky/Eddy/SAF
#===================================================

[gcode_macro _SENSORLESS_PARAMS]
variable_homing_current: 1.5
variable_safe_z: 3
variable_force_move: True
variable_homing_move_away_x: 10
variable_homing_move_away_y: 10
variable_homing_move_away_z: 10
variable_repeat_home_xy: True
variable_home_y_before_x: False
gcode:

[force_move]
enable_force_move: true

# Disable direct FORCE_MOVE command - use SET_KINEMATIC_POSITION instead
[gcode_macro FORCE_MOVE]
rename_existing: _FORCE_MOVE_BAD
variable_disable_force_move: True
gcode:
    {% if disable_force_move %}
        RESPOND TYPE=command MSG="Use SET_KINEMATIC_POSITION instead of FORCE_MOVE"
    {% else %}
        _FORCE_MOVE_BAD {rawparams}
    {% endif %}

#===================================================
# MAIN HOMING OVERRIDE
#===================================================
[homing_override]
axes: xyz
gcode:
    {% set uparams = rawparams | upper %}
    {% set home_x = 'X' in uparams %}
    {% set home_y = 'Y' in uparams %}
    {% set home_z = 'Z' in uparams %}
    {% set home_all = (home_x and home_y and home_z) or (not home_x and not home_y and not home_z) %}

    {% set sensorless_homing = (
        'virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin and
        'virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin
    ) %}
    {% set repeat_home_xy = printer["gcode_macro _SENSORLESS_PARAMS"].repeat_home_xy %}
    {% set home_count = 2 if sensorless_homing and repeat_home_xy else 1 %}
    {% set home_y_before_x = printer["gcode_macro _SENSORLESS_PARAMS"].home_y_before_x %}
    {% set home_axes_order = ['y', 'x'] if home_y_before_x else ['x', 'y'] %}

    G90

    # Safe Z lift before any XY motion
    {% if home_all or home_x or home_y %}
        _PRE_HOME_XY HOME_ALL={1 if home_all else 0}
    {% endif %}

    #======================
    # SENSORLESS X/Y HOMING
    #======================
    {% for repeat in range(0, home_count) %}
        {% for axes in home_axes_order %}
            {% if axes == 'x' and (home_all or home_x) %}
                _PRE_HOME_X
                G28 X
                _POST_HOME_X
            {% elif axes == 'y' and (home_all or home_y) %}
                _PRE_HOME_Y
                G28 Y
                _POST_HOME_Y
            {% endif %}
        {% endfor %}
    {% endfor %}

    # Move to bed center after XY homing
    {% if home_all or (home_x and home_y) %}
        _POST_HOME_XY
    {% endif %}

    #======================
    # CARTOGRAPHER Z HOMING
    #======================
    {% if home_all or home_z %}
        _PRE_HOME_Z
        G28 Z
        _POST_HOME_Z
    {% endif %}

#===================================================
# PRE-HOMING MACROS
#===================================================

[gcode_macro _PRE_HOME_XY]
gcode:
    # CRITICAL SAFETY: Lift Z before XY motion if not fully homed
    # This handles: first power-on, after M84, or after partial homing
    {% set force_move = printer["gcode_macro _SENSORLESS_PARAMS"].force_move %}
    {% set safe_z = printer["gcode_macro _SENSORLESS_PARAMS"].safe_z|int %}
    {% set home_all = (params.HOME_ALL|default(0)|int == 1) %}

    {% if printer.toolhead.homed_axes != "xyz" and force_move %}
        RESPOND TYPE=command MSG="Force moving Z {safe_z}mm for safety"
        SET_KINEMATIC_POSITION Z=0
        G0 Z{safe_z} F600
        M400  # Wait for move to complete
        {% if not home_all %}
            SET_KINEMATIC_POSITION CLEAR=Z
        {% endif %}
    {% endif %}

[gcode_macro _PRE_HOME_X]
gcode:
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin) %}
    {% if sensorless_homing %}
        {% set HOMING_CURRENT = printer["gcode_macro _SENSORLESS_PARAMS"].homing_current %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOMING_CURRENT}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOMING_CURRENT}
    {% endif %}

[gcode_macro _PRE_HOME_Y]
gcode:
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin) %}
    {% if sensorless_homing %}
        {% set HOMING_CURRENT = printer["gcode_macro _SENSORLESS_PARAMS"].homing_current %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOMING_CURRENT}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOMING_CURRENT}
    {% endif %}

[gcode_macro _PRE_HOME_Z]
gcode:
    # Cartographer probe requires no attach/dock logic
    G90

#===================================================
# POST-HOMING MACROS
#===================================================

[gcode_macro _POST_HOME_X]
gcode:
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_x'].endstop_pin) %}
    {% if sensorless_homing %}
        {% set homing_move_away_x = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_x %}
        {% set x_position_endstop = printer.configfile.settings['stepper_x'].position_endstop %}
        {% set x_position_min = printer.configfile.settings['stepper_x'].position_min %}
        
        G91
        {% if x_position_endstop > x_position_min %}
            G1 X-{homing_move_away_x} F1200
        {% else %}
            G1 X+{homing_move_away_x} F1200
        {% endif %}

        # Wait for StallGuard registers to clear
        G4 P1000
        
        # Restore run currents
        {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
        {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    {% endif %}

[gcode_macro _POST_HOME_Y]
gcode:
    {% set sensorless_homing = ('virtual_endstop' in printer.configfile.settings['stepper_y'].endstop_pin) %}
    {% if sensorless_homing %}
        {% set homing_move_away_y = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_y %}
        {% set y_position_endstop = printer.configfile.settings['stepper_y'].position_endstop %}
        {% set y_position_min = printer.configfile.settings['stepper_y'].position_min %}
        
        G91
        {% if y_position_endstop > y_position_min %}
            G1 Y-{homing_move_away_y} F1200
        {% else %}
            G1 Y+{homing_move_away_y} F1200
        {% endif %}

        # Wait for StallGuard registers to clear
        G4 P1000
        
        # Restore run currents
        {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
        {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    {% endif %}

[gcode_macro _POST_HOME_Z]
gcode:
    {% set homing_move_away_z = printer["gcode_macro _SENSORLESS_PARAMS"].homing_move_away_z|int %}
    G90
    G1 Z{homing_move_away_z} F1200

[gcode_macro _POST_HOME_XY]
gcode:
    {% if "xy" in printer.toolhead.homed_axes %}
        {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max/2 %}
        {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max/2 %}
        G90
        G0 X{POSITION_X} Y{POSITION_Y} F3200
    {% endif %}