# =========================================================
# SENSORLESS TUNING TOOLSET (Manual Diagnostic Macros)
# Designed for simple, safe testing of SGTHRS values
# =========================================================

[gcode_macro DISABLE_MOTORS]
description: Disable steppers to move toolhead manually
gcode:
  M84

# [gcode_macro CLEAR_POSITION_KINEMATICS]
# description: Set XYZ position back to zero
# gcode:
#   SET_KINEMATIC_POSITION CLEAR=XYZ

[gcode_macro SENSORLESS_STALL]
description: "Manual universal sensorless homing test"
variable_axis: ""
variable_value: 0
gcode:
    {% set axis = params.AXIS|default("")|upper %}
    {% set stall_value = params.VALUE|default(0)|int %}
    {% set abort = False %}

    # Validate AXIS
    {% if axis not in ['X','Y'] %}
        RESPOND TYPE=error MSG="ERROR: Must supply AXIS=X or AXIS=Y"
        {% set abort = True %}
    {% endif %}

    {% if abort %}
        RESPOND MSG="SENSORLESS_STALL aborted."
    {% else %}
        # Map AXIS â†’ STEPPER
        {% if axis == 'X' %}
            {% set stepper = 'stepper_x' %}
        {% elif axis == 'Y' %}
            {% set stepper = 'stepper_y' %}
        {% endif %}

        RESPOND MSG="Testing sensorless stall on {axis} (SGTHRS={stall_value})"

        # Clear kinematic position
        SET_KINEMATIC_POSITION CLEAR=XYZ

        # Apply stallguard threshold
        SET_TMC_FIELD STEPPER={stepper} FIELD=SGTHRS VALUE={stall_value}
        RESPOND MSG="SGTHRS for {stepper} set to {stall_value}"

        # Perform homing on requested axis
        G28 {axis}

        RESPOND MSG="Finished sensorless homing test on {axis}"
    {% endif %}

[gcode_macro TMC_DUMP]
description: Dump TMC for a selected stepper (default X)
variable_stepper_motor: "x"  # default axis: x
gcode:
  {% set axis = params.STEPPER|default(stepper_motor)|lower %}
  DUMP_TMC STEPPER=stepper_{axis}

[gcode_macro TMC_DUMP_DRV_STATUS]
description: Dump TMC for Driver Statys for a selected stepper (default X)
variable_stepper_motor: "x"  # default axis: x
gcode:
  {% set axis = params.STEPPER|default(stepper_motor)|lower %}
  DUMP_TMC STEPPER=stepper_x REGISTER=DRV_STATUS

