# =========================================================
# SENSORLESS TUNING TOOLSET (Manual Diagnostic Macros)
# Designed for simple, safe testing of SGTHRS values
# =========================================================

[gcode_macro DIASBLE_STEPPERS]
description: "Disable Steppers to manually move the toolhead"
gcode:
  M84

[gcode_macro STALL_X]
description: "Manual sensorless homing test: X axis"
# variable_stepper_name
# variable_stall_guard
gcode:
    # M84                          ; turn off steppers
    SET_KINEMATIC_POSITION CLEAR=XYZ
    SET_TMC_FIELD STEPPER={stepper_name} FIELD=SGTHRS VALUE=55
    RESPOND MSG="SGTHRS for X set to 55"
    G28 X
    RESPOND MSG="Finished homing X"

[gcode_macro STALL_Y]
description: "Manual sensorless homing test: Y axis"
gcode:
    # M84
    SET_KINEMATIC_POSITION CLEAR=XYZ
    SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE=60
    RESPOND MSG="SGTHRS for Y set to 60"
    G28 Y
    RESPOND MSG="Finished homing Y"

[gcode_macro STALL_BOTH]
description: "Manual sensorless homing test: X + Y"
gcode:
    # M84
    SET_KINEMATIC_POSITION CLEAR=XYZ

    # X first
    SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE=55
    RESPOND MSG="SGTHRS_X = 55"
    G28 X

    # Y second
    SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE=60
    RESPOND MSG="SGTHRS_Y = 60"
    G28 Y

    RESPOND MSG="Finished homing X + Y"

[gcode_macro TMC_DUMP_X]
description: "Dump all TMC registers for X"
gcode:
    RESPOND MSG="=== TMC DUMP: X ==="
    DUMP_TMC STEPPER=stepper_x

[gcode_macro TMC_DUMP_Y]
description: "Dump all TMC registers for Y"
gcode:
    RESPOND MSG="=== TMC DUMP: Y ==="
    DUMP_TMC STEPPER=stepper_y



[gcode_macro TMC_DUMP]
description: Dump TMC for a selected stepper (default X)
variable_stepper_motor: "x"  # default axis: x
gcode:
  {% set axis = params.STEPPER|default(stepper_motor)|lower %}
  DUMP_TMC STEPPER=stepper_{axis}

[gcode_macro TMC_DUMP_X]
description: Dump TMC for a selected stepper (default X)
gcode:
  DUMP_TMC STEPPER=stepper_x REGISTER=DRV_STATUS

[gcode_macro TMC_DUMP_Y]
description: Dump TMC for a selected stepper (default X)
gcode:
  DUMP_TMC STEPPER=stepper_y REGISTER=DRV_STATUS
