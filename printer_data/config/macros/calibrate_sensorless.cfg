# =========================================================
# SENSORLESS TUNING TOOLSET (Manual Diagnostic Macros)
# Designed for simple, safe testing of SGTHRS values
# =========================================================

[gcode_macro SENSORLESS_STALL]
description: "Manual universal sensorless homing test"
variable_axis: ""
variable_value: 0
gcode:
    {% set axis = params.AXIS|default("")|upper %}
    {% set stall_value = params.VALUE|default(0)|int %}
    {% set abort = False %}

    # Validate AXIS
    {% if axis not in ['X','Y'] %}
        RESPOND TYPE=error MSG="ERROR: Must supply AXIS=X or AXIS=Y"
        {% set abort = True %}
    {% endif %}

    {% if abort %}
        RESPOND MSG="SENSORLESS_STALL aborted."
    {% else %}
        # Map AXIS â†’ STEPPER
        {% if axis == 'X' %}
            {% set stepper = 'stepper_x' %}
        {% elif axis == 'Y' %}
            {% set stepper = 'stepper_y' %}
        {% endif %}

        RESPOND MSG="Testing sensorless stall on {axis} (SGTHRS={stall_value})"

        # Clear kinematic position
        SET_KINEMATIC_POSITION CLEAR=XYZ

        # Apply stallguard threshold
        SET_TMC_FIELD STEPPER={stepper} FIELD=SGTHRS VALUE={stall_value}
        RESPOND MSG="SGTHRS for {stepper} set to {stall_value}"

        # Perform homing on requested axis
        G28 {axis}

        RESPOND MSG="Finished sensorless homing test on {axis}"
    {% endif %}

[gcode_macro TMC_DUMP]
description: Dump TMC for a selected stepper (default X)
variable_stepper_motor: "x"  # default axis: x
gcode:
  {% set axis = params.STEPPER|default(stepper_motor)|lower %}
  DUMP_TMC STEPPER=stepper_{axis}

[gcode_macro TMC_DUMP_X]
description: Dump TMC for a selected stepper (default X)
gcode:
  DUMP_TMC STEPPER=stepper_x REGISTER=DRV_STATUS

[gcode_macro TMC_DUMP_Y]
description: Dump TMC for a selected stepper (default X)
gcode:
  DUMP_TMC STEPPER=stepper_y REGISTER=DRV_STATUS

# [gcode_macro STALL_Y]
# description: "Manual sensorless homing test: Y axis"
# gcode:
#     # M84
#     SET_KINEMATIC_POSITION CLEAR=XYZ
#     SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE=60
#     RESPOND MSG="SGTHRS for Y set to 60"
#     G28 Y
#     RESPOND MSG="Finished homing Y"

# [gcode_macro STALL_BOTH]
# description: "Manual sensorless homing test: X + Y"
# gcode:
#     # M84
#     SET_KINEMATIC_POSITION CLEAR=XYZ

#     # X first
#     SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE=55
#     RESPOND MSG="SGTHRS_X = 55"
#     G28 X

#     # Y second
#     SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE=60
#     RESPOND MSG="SGTHRS_Y = 60"
#     G28 Y

#     RESPOND MSG="Finished homing X + Y"

# [gcode_macro TMC_DUMP_X]
# description: "Dump all TMC registers for X"
# gcode:
#     RESPOND MSG="=== TMC DUMP: X ==="
#     DUMP_TMC STEPPER=stepper_x

# [gcode_macro TMC_DUMP_Y]
# description: "Dump all TMC registers for Y"
# gcode:
#     RESPOND MSG="=== TMC DUMP: Y ==="
#     DUMP_TMC STEPPER=stepper_y
