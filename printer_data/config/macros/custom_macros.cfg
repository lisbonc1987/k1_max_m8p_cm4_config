[gcode_macro _bot_data]
variable_lapse_video_size: 0
variable_lapse_filename: 'None'
variable_lapse_path: 'None'
gcode:
    M118 Setting bot lapse variables

[gcode_macro PID_CALIBRATE_BED]
description: Bed Pid Calibrate
variable_bed_temp: 80
gcode:
  {% if printer.print_stats.state != "printing" %}
    PID_CALIBRATE HEATER=heater_bed TARGET={params.BED_TEMP|default(bed_temp)}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}

[gcode_macro PID_CALIBRATE_HOTEND]
description: Hotend Pid Calibrate
variable_hotend_temp: 230
gcode:
  {% if printer.print_stats.state != "printing" %}
    PID_CALIBRATE HEATER=extruder TARGET={params.HOTEND_TEMP|default(hotend_temp)}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}

[gcode_macro INPUT_SHAPER]
description: Run shaper calibrate and choose default shapers
gcode:
  {% if printer.print_stats.state != "printing" %}
    {% set kinematics = printer.configfile.settings['printer'].kinematics %}
    {% set axis = params.AXIS | default('') | upper %}
    {% if kinematics != 'cartesian' or axis == 'X' or axis == 'Y' %}
      {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
      {% endif %}
      {% if axis != '' %}
        SHAPER_CALIBRATE AXIS={axis}
      {% else %}
        SHAPER_CALIBRATE
      {% endif %}
    {% else %}
      RESPOND TYPE=error MSG='You must specify an AXIS (X or Y)'
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}
  MOVE_SHAPER_CALIBRATION

# [gcode_macro LOAD_FILAMENT]
# description: Manually load filament (for use when idle)
# variable_target_temp: 220

# gcode:
#   {% set target_temp = params.TEMP|default(printer['gcode_macro _START_END_PARAMS'].default_filament_temp)|float %}
#   {% set tip_distance = printer['gcode_macro _START_END_PARAMS'].tip_distance|float %}
  
#   M109 S{target_temp}
#   RESPOND TYPE=command MSG="Loading filament at {target_temp}°C..."
#   M83
#   G1 E100 F180                     # Load filament
#   G1 E-{tip_distance} F300         # Retract using your tip_distance variable
#   M400
#   SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
#   BEEP
#   {action_respond_info("Filament loaded. You can now call LOAD_FILAMENT TEMP=240 for different temps.")}

#   [gcode_macro LOAD_FILAMENT]
# description: Manually load filament (for use when idle)
# variable_target_temp: 220


# [gcode_macro LOAD_FILAMENT]
# description: Manually load filament (for use when idle)
# variable_load_temp: 220
# gcode:
#   # {% set target_temp = params.TEMP|default(printer['gcode_macro _START_END_PARAMS'].default_filament_temp)|float %}
#   {% set tip_distance = printer['gcode_macro _START_END_PARAMS'].tip_distance|float %}
  
#   M109 S{load_temp}
#   RESPOND TYPE=info MSG="Loading filament at {load_temp}°C..."
#   M83
#   G1 E100 F180                     # Load filament
#   G1 E-{tip_distance} F300         # Retract using your tip_distance variable
#   RESPOND TYPE=info MSG="Retracting {tip_distance}mm"
#   M109 S150
  
#   M400
#   SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
#   {action_respond_info("Filament loaded. Goodbye")}

# [gcode_macro UNLOAD_FILAMENT]
# description: Manually unload filament (for use when idle)
# variable_unload_temp: 220
# gcode:
#   # {% set target_temp = params.TEMP|default(printer['gcode_macro _START_END_PARAMS'].default_filament_temp)|float %}
  
#   M109 S{unload_temp}
#   RESPOND TYPE=info MSG="Unloading filament at {target_temp}°C..."
#   M106 S255                      # Turn on side fan at 55%
#   M83                            # relative extruder 
  
#   RESPOND TYPE= info MSG="Begin unload filament and tip shape"
#   M104 S{target_temp - 30}       # Start cooling (don't wait)
#   G4 P5000                       # Wait for initial cooldown
#   G1 E30 F180                    # initially purge larger due to nozzle length
#   G1 E-12 F600                   # Medium retract -12
#   G4 P1000                       # Wait
#   G1 E4 F120                     # Small extrude -8
#   G1 E-18 F1400                  # Fast retract -26
#   G4 P500                        # Wait
#   G1 E2 F90                      # Tiny extrude -24
#   G1 E-24 F2200                  # Very fast retract -48
#   G1 E-50 F2800                  # Final snap retract -98
#   M400
  
#   SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
#   M106 S0                        # Turn off side fan
#   {action_respond_info("Filament unloaded. You can now call UNLOAD_FILAMENT TEMP=240 for different temps.")}

[gcode_macro LOAD_FILAMENT_MANUAL]
description: Manually load filament with filament type selection
variable_selected_filament: 'PLA'
variable_selected_temp: 210
gcode:
  # Show filament selection prompt
  RESPOND TYPE=command MSG="action:prompt_begin Load Filament - Select Filament Type"
  RESPOND TYPE=command MSG="action:prompt_text Please select your filament type:"
  RESPOND TYPE=command MSG="action:prompt_text  "
  RESPOND TYPE=command MSG="action:prompt_button PLA (210°C)|_LOAD_FILAMENT_PLA|primary"
  RESPOND TYPE=command MSG="action:prompt_button PETG (230°C)|_LOAD_FILAMENT_PETG|secondary"
  RESPOND TYPE=command MSG="action:prompt_button ABS (250°C)|_LOAD_FILAMENT_ABS|secondary"
  RESPOND TYPE=command MSG="action:prompt_text  "
  RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=action:prompt_end|error"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _LOAD_FILAMENT_PLA]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=LOAD_FILAMENT_MANUAL VARIABLE=selected_filament VALUE="'PLA'"
  SET_GCODE_VARIABLE MACRO=LOAD_FILAMENT_MANUAL VARIABLE=selected_temp VALUE=210
  _EXECUTE_LOAD_FILAMENT

[gcode_macro _LOAD_FILAMENT_PETG]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=LOAD_FILAMENT_MANUAL VARIABLE=selected_filament VALUE="'PETG'"
  SET_GCODE_VARIABLE MACRO=LOAD_FILAMENT_MANUAL VARIABLE=selected_temp VALUE=230
  _EXECUTE_LOAD_FILAMENT

[gcode_macro _LOAD_FILAMENT_ABS]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=LOAD_FILAMENT_MANUAL VARIABLE=selected_filament VALUE="'ABS'"
  SET_GCODE_VARIABLE MACRO=LOAD_FILAMENT_MANUAL VARIABLE=selected_temp VALUE=250
  _EXECUTE_LOAD_FILAMENT_MANUAL

[gcode_macro _EXECUTE_LOAD_FILAMENT_MANUAL]
gcode:
  {% set target_temp = printer['gcode_macro LOAD_FILAMENT_MANUAL'].selected_temp|int %}
  {% set filament_type = printer['gcode_macro LOAD_FILAMENT_MANUAL'].selected_filament|string|upper %}
  {% set tip_distance = printer['gcode_macro _START_END_PARAMS'].tip_distance|float %}
  {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max * 0.99 %}
  {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max / 2 %}

  {% if not printer.toolhead.homed_axes %}
        M104 S{target_temp} ; heat right away as it is homning
        G28
  {% endif %}
  
  # Filaments that are definitely safe for rapid cooling
  {% set cooling_safe_filaments = ['PLA', 'PLA-AERO', 'PLA-CF'] %}
  
  # PETG variants can handle some cooling but be more gentle
  {% set petg_variants = ['PETG', 'PETG-CF', 'PETG-CF10', 'PETG-GF'] %}
  
  {% set use_cooling = filament_type in cooling_safe_filaments %}
  {% set use_gentle_cooling = filament_type in petg_variants %}

  M118 {"Loading %s at %d°C..." % (filament_type, target_temp)}

  # {action_respond_info("Loading %s at %s°C..." % (filament_type, target_temp))}
  # RESPOND MSG="Loading {filament_type} at {target_temp}°C..."
  
  # Heat to loading temp if it's not there yet
  M109 S{target_temp}
  
  # Load filament
  M83
  G1 E100 F180                     # Load filament
  G1 E-{tip_distance} F300         # Retract using your tip_distance variable
  M118 {"Retracting %.2f mm of tip distance" % (tip_distance)}
  # {action_respond_info("Retracting %.2f mm of tip distance" % (tip_distance))}
  # RESPOND MSG="Retracting {tip_distance}mm"
  
  # Park near side fan
  G90
  G1 X{POSITION_X} Y{POSITION_Y} F6000
  
  # Apply cooling based on filament type
  {% if use_cooling %}
    SET_FAN_SPEED FAN=Part_Fan SPEED=1               ; full cooling for PLA
    SET_FAN_SPEED FAN=Side_Fan SPEED=1
  {% elif use_gentle_cooling %}
    SET_FAN_SPEED FAN=Part_Fan SPEED=0.5             ; gentle cooling for PETG
    SET_FAN_SPEED FAN=Side_Fan SPEED=0.5
  {% endif %}
  
  # Cool down based on filament type
  {% if use_cooling or use_gentle_cooling %}
    M109 S150                ; cool nozzle to 150°C (wait)
  {% else %}
    M109 S200                ; cool nozzle to 200°C for high-temp materials
  {% endif %}
  
  # Turn off fans
  {% if use_cooling or use_gentle_cooling %}
    SET_FAN_SPEED FAN=Part_Fan SPEED=0
    SET_FAN_SPEED FAN=Side_Fan SPEED=0
  {% endif %}
  
  # Turn off hotend
  M104 S0
  
  M400
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
  M118 {"Filament loaded successfully. Hotend cooling complete."}
  # {action_respond_info("Filament loaded successfully. Hotend cooling complete.")}

[gcode_macro UNLOAD_FILAMENT_MANUAL]
description: Manually unload filament with filament type selection
variable_selected_temp: 220
gcode:
  # Show filament selection prompt
  RESPOND TYPE=command MSG="action:prompt_begin Unload Filament - Select Filament Type"
  RESPOND TYPE=command MSG="action:prompt_text Please select your filament type:"
  RESPOND TYPE=command MSG="action:prompt_text  "
  RESPOND TYPE=command MSG="action:prompt_button PLA (210°C)|_UNLOAD_FILAMENT_PLA|primary"
  RESPOND TYPE=command MSG="action:prompt_button PETG (230°C)|_UNLOAD_FILAMENT_PETG|secondary"
  RESPOND TYPE=command MSG="action:prompt_button ABS (250°C)|_UNLOAD_FILAMENT_ABS|secondary"
  RESPOND TYPE=command MSG="action:prompt_text  "
  RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=action:prompt_end|error"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UNLOAD_FILAMENT_PLA]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=UNLOAD_FILAMENT_MANUAL VARIABLE=selected_temp VALUE=210
  _EXECUTE_UNLOAD_FILAMENT_MANUAL

[gcode_macro _UNLOAD_FILAMENT_PETG]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=UNLOAD_FILAMENT_MANUAL VARIABLE=selected_temp VALUE=230
  _EXECUTE_UNLOAD_FILAMENT_MANUAL

[gcode_macro _UNLOAD_FILAMENT_ABS]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=UNLOAD_FILAMENT_MANUAL VARIABLE=selected_temp VALUE=250
  _EXECUTE_UNLOAD_FILAMENT_MANUAL

[gcode_macro _EXECUTE_UNLOAD_FILAMENT_MANUAL]
gcode:
  {% set target_temp = printer['gcode_macro UNLOAD_FILAMENT_MANUAL'].selected_temp|int %}
  
  {action_respond_info("Unloading filament at %d°C..." % (target_temp))}
  
  # Heat to unload temp
  M109 S{target_temp}
  
  {action_respond_info("Hotend at temperature. Starting tip shaping...")}
  
  # Turn on cooling fan to help with temperature drop
  M106 S255
  M83
  
  M104 S{target_temp - 30}       # Start cooling (don't wait)
  G4 P5000                       # Wait for initial cooldown
  
  {action_respond_info("Performing tip shaping sequence...")}
  
  G1 E30 F180                    # initially purge larger due to nozzle length
  G1 E-12 F600                   # Medium retract -12
  G4 P1000                       # Wait
  G1 E4 F120                     # Small extrude -8
  G1 E-18 F1400                  # Fast retract -26
  G4 P500                        # Wait
  G1 E2 F90                      # Tiny extrude -24
  G1 E-24 F2200                  # Very fast retract -48
  G1 E-50 F2800                  # Final snap retract -98
  
  {action_respond_info("Tip shaping complete. Finishing up...")}
  
  M400
  
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
  M106 S0                        # Turn off fan
  M104 S0                        # Turn off hotend
  BEEP
  {action_respond_info("Filament unloaded successfully.")}

# [gcode_macro _EXECUTE_UNLOAD_FILAMENT]
# gcode:
#   {% set target_temp = printer['gcode_macro UNLOAD_FILAMENT'].selected_temp|int %}
  
#   RESPOND MSG="Unloading filament at {target_temp}°C..."
  
#   # Heat to unload temp
#   M109 S{target_temp}
  
#   # Turn on cooling fan to help with temperature drop
#   M106 S255
#   M83
  
#   RESPOND MSG="Begin unload filament and tip shape"
#   M104 S{target_temp - 30}       # Start cooling (don't wait)
#   G4 P5000                       # Wait for initial cooldown
#   G1 E30 F180                    # initially purge larger due to nozzle length
#   G1 E-12 F600                   # Medium retract -12
#   G4 P1000                       # Wait
#   G1 E4 F120                     # Small extrude -8
#   G1 E-18 F1400                  # Fast retract -26
#   G4 P500                        # Wait
#   G1 E2 F90                      # Tiny extrude -24
#   G1 E-24 F2200                  # Very fast retract -48
#   G1 E-50 F2800                  # Final snap retract -98
#   M400
  
#   SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
#   M106 S0                        # Turn off fan
#   M104 S0                        # Turn off hotend
#   BEEP
#   {action_respond_info("Filament unloaded successfully.")}

#ADDITIONAL MACROS (M106, M107, etc)

# [gcode_macro M106]
# description: Set Fan Speed. P0 for part, P2 for auxiliary, P3 chamber
# gcode:
#   {% set fan_map = {0: "Part_Fan", 2: "Side_Fan", 3: "Chamber_Fan"} %}
#   {% set fan_id = params.P|default(0)|int %}
#   {% set fan = fan_map[fan_id] %}
#   {% set speed_param = params.S|default(255)|int %}
#   {% if speed_param > 0 %}
#     {% set speed = (speed_param|float / 255) %}
#   {% else %}
#     {% set speed = 0 %}
#   {% endif %}
#   SET_FAN_SPEED FAN={fan} SPEED={speed}

# [gcode_macro M107]
# description: Set Fan Off. P0 for part, P2 for auxiliary, P3 chamber
# gcode:
#   {% set fan_map = {0: "Part_Fan", 2: "Side_Fan", 3: "Chamber_Fan"} %}
#   {% set fan_id = params.P|default(0)|int %}
#   {% set fan = fan_map[fan_id] %}
#   SET_FAN_SPEED FAN={fan} SPEED=0

# [gcode_macro M109]
# description: Wait for hot end temp before proceeding (does not wait to stabilize)
# rename_existing: M99109
# gcode:
#     #Parameters
#     {% set s = params.S|float %}
    
#     M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
#     {% if s != 0 %}
#         TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}   ; Wait for hotend temp (within 1 degree)
#     {% endif %}

# [gcode_macro M141]
# description: Set Chamber temperature with slicers
# gcode:
#   SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber_fan TARGET={params.S|default(35)}

# [gcode_macro M900]
# gcode:
#   {% if 'K' in params %}
#     {% if 'E' in params %}
#       SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
#     {% else %}
#       SET_PRESSURE_ADVANCE ADVANCE={params.K}
#     {% endif %}
#   {% endif %}

# [gcode_macro SET_E_MIN_CURRENT]
# gcode:
#   {% set e_current = printer['gcode_macro _START_END_PARAMS'].e_min_current %}  # Changed from PRINTER_PARAM
#   M400
#   SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
#   G4 P2000

# [gcode_macro RESTORE_E_CURRENT]
# gcode:
#   {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}
#   M400
#   SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
#   G4 P2000

# [gcode_macro z_home_test]
# gcode:
#   {% set STEPS = params.STEPS|default(5)|int %}
#   M400
#   {% for step in range(STEPS) %}
#     M400
#     G91
#     G1 Z+10 F1500
#     G90
#     G28 Z
#   {% endfor %}
