[gcode_macro _bot_data]
variable_lapse_video_size: 0
variable_lapse_filename: 'None'
variable_lapse_path: 'None'
gcode:
    M118 Setting bot lapse variables

[gcode_macro PID_CALIBRATE_BED]
description: Bed Pid Calibrate
variable_bed_temp: 80
gcode:
  {% if printer.print_stats.state != "printing" %}
    PID_CALIBRATE HEATER=heater_bed TARGET={params.BED_TEMP|default(bed_temp)}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}

[gcode_macro PID_CALIBRATE_HOTEND]
description: Hotend Pid Calibrate
variable_hotend_temp: 230
gcode:
  {% if printer.print_stats.state != "printing" %}
    PID_CALIBRATE HEATER=extruder TARGET={params.HOTEND_TEMP|default(hotend_temp)}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}

[gcode_macro INPUT_SHAPER]
description: Run shaper calibrate and choose default shapers
gcode:
  {% if printer.print_stats.state != "printing" %}
    {% set kinematics = printer.configfile.settings['printer'].kinematics %}
    {% set axis = params.AXIS | default('') | upper %}
    {% if kinematics != 'cartesian' or axis == 'X' or axis == 'Y' %}
      {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
      {% endif %}
      {% if axis != '' %}
        SHAPER_CALIBRATE AXIS={axis}
      {% else %}
        SHAPER_CALIBRATE
      {% endif %}
    {% else %}
      RESPOND TYPE=error MSG='You must specify an AXIS (X or Y)'
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}
  MOVE_SHAPER_CALIBRATION

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set target_temp = printer['gcode_macro RESUME'].etemp|default(220)|int %}
    M109 S{target_temp}
    RESPOND TYPE=command MSG="Unloading filament..."

    # Turn on cooling fan to help with temperature drop
    M106 S255
    
    M83

    #### K1* Unicorn Nozzle/Heatbreak/Extruder Geometry:
    ## pipe - heatbreak - pipe - nozzle
    ## 23.6 - 10.5      - 3    - 28.3 - total 65.4mm
    ### Positions:
    ## E-28.3 = unloaded from nozzle/heater
    ## E-36.55 = unloaded from nozzle/hb until middle of heatbreak
    ## E-42.3 = unloaded from nozzle and hb = between heatbreak and extruder drive gears, hand pullable with lever opened
    ## E-77.5 = unloaded from nozzle, hb and extruder = beyond extruder drive gears, hand pullable with lever closed

    RESPOND MSG="Begin unload filament and tip shape"
    M104 S{target_temp - 30}       # Start cooling (don't wait)
    G4 P5000                       # Wait for initial cooldown
    G1 E30 F180                    # initially purge larger due to nozzle length
    G1 E-12 F600                   # Medium retract -12
    G4 P1000                       # Wait
    G1 E4 F120                     # Small extrude -8
    G1 E-18 F1400                  # Fast retract -26
    G4 P500                        # Wait
    G1 E2 F90                      # Tiny extrude -24
    G1 E-24 F2200                  # Very fast retract -48
    G1 E-50 F2800                  # Final snap retract -98
      
    M400

    # turn off extruder to help it avoid overheating
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    BEEP
    # restore temperature
    M109 S{target_temp}


[gcode_macro LOAD_FILAMENT]
gcode:
  {% set target_temp = printer['gcode_macro RESUME'].etemp|default(220)|int %}
  {% set tip_distance = printer["gcode_macro _START_END_PARAMS"].tip_distance|float %}
  M109 S{target_temp}
  RESPOND TYPE=command MSG="Loading filament..."
  M83
  G1 E100 F180                     # Load filament
  G1 E-{tip_distance} F300         # Retract using your tip_distance variable
  M400
  # turn off extruder to help it avoid overheating
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
  BEEP


[gcode_macro PURGE_MORE]
gcode:
  {% set target_temp = printer['gcode_macro RESUME'].etemp|default(220)|int %}
  {% set tip_distance = printer["gcode_macro _START_END_PARAMS"].tip_distance|float %}
  M109 S{target_temp}
  RESPOND TYPE=command MSG="Purging filament..."
  M83
  G1 E10 F180
  G1 E-{tip_distance} F300         # Retract using your tip_distance variable
  M400
  # turn off extruder to help it avoid overheating
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
  BEEP

[gcode_macro _FC_CANCEL]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  CANCEL_PRINT

[gcode_macro _FC_RESUME]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  RESUME

[gcode_macro M600]
description: Filament Change
gcode:
  RESPOND TYPE=command MSG="M600 - Print paused for filament change"
  PAUSE RESTORE=0
  RESPOND TYPE=command MSG="action:prompt_begin M600 - Filament Change - UNLOAD Filament"
  RESPOND TYPE=command MSG="action:prompt_text BEEP BEEP - Unloading Filament ..."
  RESPOND TYPE=command MSG="action:prompt_text ... ... ..."
  RESPOND TYPE=command MSG="action:prompt_text ... Please wait for BEEP."
  RESPOND TYPE=command MSG="action:prompt_show"
  BEEP
  BEEP
  _UNLOAD_FILAMENT
  SET_FAN_SPEED FAN=Part_Fan SPEED=0
  SET_FAN_SPEED FAN=Side_Fan SPEED=0
  RESPOND TYPE=command MSG="action:prompt_begin M600 - Filament Change - LOAD Filament"
  RESPOND TYPE=command MSG="action:prompt_text BEEP - Filament unloaded. Replace Filament, click LOAD, remove purged material and click RESUME when ready to continue print."
  RESPOND TYPE=command MSG="action:prompt_text  "
  RESPOND TYPE=command MSG="action:prompt_button LOAD Filament|_LOAD_FILAMENT|secondary"
  RESPOND TYPE=command MSG="action:prompt_button PURGE MORE Filament|_PURGE_MORE|secondary"
  RESPOND TYPE=command MSG="action:prompt_text  "
  RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL PRINT|_FC_CANCEL|error"
  RESPOND TYPE=command MSG="action:prompt_footer_button IGNORE|RESPOND TYPE=command MSG=action:prompt_end|warning"
  RESPOND TYPE=command MSG="action:prompt_footer_button RESUME|_FC_RESUME|primary"
  RESPOND TYPE=command MSG="action:prompt_show"